<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API 测试工具</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }
        input[type="text"], textarea, input[type="number"] {
            box-sizing: border-box;
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        .button-container {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        button {
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin-top: 10px;
            width: 31%;
        }
        button:hover {
            background-color: #218838;
        }
        .button-container button {
            display: flex;
            align-items: center;
            gap: 5px;
            justify-content: center;
        }
        #chatHistory {
            margin-top: 20px;
            border: 1px solid #ccc;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
            overflow: auto;
            max-height: 300px;
        }
        .message {
            margin-bottom: 10px;
            padding: 5px;
            border-radius: 4px;
        }
        .user {
            background-color: #e6f3ff;
        }
        .assistant {
            background-color: #f0f0f0;
        }
        .message.assistant.error {
            background-color: #ffefe8; /*  柔和的红白 */
            /*  其他错误样式，例如：*/
            color: #b91c1c; /*  深红色文字 */
            font-weight: bold;
            border: 1px solid #ef4444; /*  红色边框 */
            padding: 10px; /* 内边距 */
        }
        .spinner {
            display: none;
            text-align: center;
            margin-top: 20px;
        }
        .spinner i {
            font-size: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .advanced-options {
            margin-top: 20px;
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 4px;
        }
        .advanced-options h3 {
            margin-top: 0;
            margin-bottom: 0;
            cursor: pointer;
        }
        .advanced-options-content {
            display: none;
        }
        .advanced-options.open .advanced-options-content {
            display: block;
        }
        .advanced-options h3:before {
            content: '▶ ';
            font-size: 0.8em;
        }
        .advanced-options.open h3:before {
            content: '▼ ';
        }
        .input-with-history {
            position: relative;
            width: 100%;
        }
        .input-row {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }
        .input-row .input-with-history {
            flex: 1;
        }
        .history-dropdown {
            box-sizing: border-box;
            display: none;
            position: absolute;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            background: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 4px;
            z-index: 1000;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .history-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .history-item .key {
            flex-grow: 1;
        }
        .history-item .url {
            color: #666;
            font-size: 0.9em;
            margin-left: 10px;
        }
        .history-item:hover {
            background-color: #ccc;
        }
        .clear-config-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 16px;
            cursor: pointer;
            margin-top: 10px;
        }
        .clear-config-btn:hover {
            background-color: #c82333;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        .modal-content {
            position: relative;
            width: 95%;
            height: 90%;
            margin: 2% auto;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .close-modal {
            position: absolute;
            right: 10px;
            top: 10px;
            font-size: 24px;
            cursor: pointer;
            background: #2c2c2c;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1001;
        }
        .close-modal:hover {
            background: #444444;
        }
        .modal iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 8px;
        }
        #openNextChat {
            width: auto;        /* 根据内容自适应宽度 */
            min-width: 40px;    /* 设置最小宽度 */
        }
        .history-item .content {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }
        .history-item .delete-btn {
            background: none;
            border: none;
            color: #ff4444;
            cursor: pointer;
            padding: 4px;
            margin: 0px;
            border-radius: 4px;
            visibility: hidden;
            width: 20px;
            height: 20px;
            min-width: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            
        }
        .history-item .delete-btn i {
            font-size: 16px;
        }
        .history-item:hover .delete-btn {
            visibility: visible;
        }
        .history-item .delete-btn:hover {
            background-color: #ffeeee;
        }
        /* 聊天历史记录样式更新 */
        #chatHistory {
            word-wrap: break-word;
            overflow-x: hidden;
        }
        .message {
            /* white-space: pre-line; */
            /* overflow-wrap: break-word; */
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
</head>
<body>
    <h1><i class="fas fa-robot"></i> API 测试工具</h1>
    <div class="container">
        <label for="url">Base URL:</label>
        <div class="input-with-history">
            <input type="text" id="url" placeholder="https://api.openai.com">
            <div id="urlHistory" class="history-dropdown"></div>
        </div>
        
        <label for="key">API Key:</label>
        <div class="input-with-history">
            <input type="text" id="key">
            <div id="keyHistory" class="history-dropdown"></div>
        </div>

        <div class="input-row">
            <div class="input-with-history">
                <label for="model">模型:</label>
                <input type="text" id="model" value="gpt-4">
                <div id="modelHistory" class="history-dropdown"></div>
            </div>
            
            <div class="input-with-history">
                <label for="endpoint">请求路径:</label>
                <input type="text" id="endpoint" value="auto" placeholder="auto（自动匹配）">
                <div id="endpointHistory" class="history-dropdown"></div>
            </div>
        </div>

        <label for="input">消息:</label>
        <textarea id="input" rows="4"></textarea>

        <div class="button-container">
            <button id="openNextChat" title="打开 NextChat 聊天窗口"><i class="fas fa-external-link-alt"></i></button>
            <button id="submit"><i class="fas fa-paper-plane"></i> 发送消息-Enter</button>
            <button id="functionTest"><i class="fas fa-code"></i> 函数/工具 调用</button>
            <button id="clearHistory"><i class="fas fa-trash-alt"></i> 清空对话历史</button>
        </div>        

        <div class="spinner"><i class="fas fa-spinner"></i></div>

        <h2>对话历史:</h2>
        <div id="chatHistory"></div>

        <div class="advanced-options">
            <h3>高级选项</h3>
            <div class="advanced-options-content">
                <label for="temperature">Temperature:</label>
                <input type="number" id="temperature" value="1" min="0" max="2" step="0.1">

                <label for="max_tokens">Max Tokens:</label>
                <input type="number" id="max_tokens" value="512" min="1">

                <label for="top_p">Top P:</label>
                <input type="number" id="top_p" value="1" min="0" max="1" step="0.1">

                <label for="frequency_penalty">Frequency Penalty:</label>
                <input type="number" id="frequency_penalty" value="0" min="-2" max="2" step="0.1">

                <label for="presence_penalty">Presence Penalty:</label>
                <input type="number" id="presence_penalty" value="0" min="-2" max="2" step="0.1">

                <button id="clearConfig" class="clear-config-btn">清除API配置历史记录</button>
            </div>
        </div>

        <div id="nextChatModal" class="modal">
            <div class="modal-content">
                <button class="close-modal" onclick="closeNextChat()">×</button>
                <iframe id="nextChatFrame"></iframe>
            </div>
        </div>
    </div>

    <script>
        let messages = [];
        const converter = new showdown.Converter({
            // simpleLineBreaks: false, // 防止自动将换行符转换为 <br>
            // strikethrough: true,
            // tables: true
        });

        // Toggle advanced options
        document.querySelector('.advanced-options h3').onclick = function() {
            this.parentElement.classList.toggle('open');
        };

        // 消息显示函数
        function displayMessage(message, type, isError = false) {
            const chatHistory = document.getElementById('chatHistory');
            let content = message.content;

            if (type === 'user' && content.includes('<')) {
                content = `<details><summary>显示 HTML 代码</summary><pre>${content}</pre></details>`;
            } else if (!isError) {
                content = converter.makeHtml(content); // Markdown 转换
            }

            const className = isError ? 'message assistant error' : `message ${type}`;
            chatHistory.innerHTML += `<div class="${className}">${content}</div>`;
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        function loadChatHistory() {
            messages = JSON.parse(localStorage.getItem('chatHistory') || '[]');
            const chatHistory = document.getElementById('chatHistory');
            chatHistory.innerHTML = ''; // 清空现有内容
            
            messages.forEach(msg => {
                displayMessage(msg, msg.role, msg.isError || false);
            });
        }

        // 配置历史记录管理
        class ConfigHistory {
            constructor(maxItems = 10) {
                this.maxItems = maxItems;
                this.commonEndpoints = [
                    { value: 'auto', label: 'auto（自动匹配）' },
                    { value: '/v1/chat/completions', label: 'OpenAI (/v1/chat/completions)' },
                    { value: '/v1/messages', label: 'Claude (/v1/messages)' }
                ];
                this.loadHistory();
                this.setupInputHandlers();
                this.loadLastUsedConfig();
                
                // 加载聊天历史记录
                this.loadChatHistory();
            }

            loadChatHistory() {
                loadChatHistory();
            }

            saveChatHistory() {
                localStorage.setItem('chatHistory', JSON.stringify(messages));
            }

            deleteHistoryItem(type, value) {
                const historyArray = this[`${type}History`];
                const index = historyArray.indexOf(value);
                const input = document.getElementById(type);
                
                if (index !== -1) {
                    historyArray.splice(index, 1);
                    
                    // 如果删除的是key，同时删除对应的URL映射
                    if (type === 'key') {
                        delete this.keyUrlMap[value];
                    }
                    
                    // 如果删除的值正好是当前输入框的值，则清空输入框
                    if (input.value === value) {
                        input.value = '';
                        // 如果是key被删除，同时清空对应的URL输入框
                        if (type === 'key') {
                            document.getElementById('url').value = '';
                        }
                    }
                    
                    this.saveHistory();
                    this.showDropdown(type); // 重新显示更新后的下拉列表
                }
            }

            loadHistory() {
                this.urlHistory = JSON.parse(localStorage.getItem('urlHistory') || '[]');
                this.keyHistory = JSON.parse(localStorage.getItem('keyHistory') || '[]');
                this.modelHistory = JSON.parse(localStorage.getItem('modelHistory') || '[]');
                this.keyUrlMap = JSON.parse(localStorage.getItem('keyUrlMap') || '{}');
                this.lastUsedConfig = JSON.parse(localStorage.getItem('lastUsedConfig') || '{}');
                this.endpointHistory = JSON.parse(localStorage.getItem('endpointHistory') || '[]');
            }

            saveHistory() {
                localStorage.setItem('urlHistory', JSON.stringify(this.urlHistory));
                localStorage.setItem('keyHistory', JSON.stringify(this.keyHistory));
                localStorage.setItem('modelHistory', JSON.stringify(this.modelHistory));
                localStorage.setItem('keyUrlMap', JSON.stringify(this.keyUrlMap));
                localStorage.setItem('endpointHistory', JSON.stringify(this.endpointHistory));
            }

            addToHistory(type, value) {
                if (!value) return;
                
                const historyArray = this[`${type}History`];
                const index = historyArray.indexOf(value);
                
                if (index !== -1) {
                    historyArray.splice(index, 1);
                }
                
                historyArray.unshift(value);
                
                if (historyArray.length > this.maxItems) {
                    historyArray.pop();
                }
                
                this.saveHistory();
            }

            updateKeyUrlMap(key, url) {
                if (key && url) {
                    this.keyUrlMap[key] = url;
                    this.saveHistory();
                }
            }

            saveLastUsedConfig() {
                const config = {
                    url: document.getElementById('url').value,
                    key: document.getElementById('key').value,
                    model: document.getElementById('model').value,
                    endpoint: document.getElementById('endpoint').value
                };
                localStorage.setItem('lastUsedConfig', JSON.stringify(config));
            }

            loadLastUsedConfig() {
                const config = JSON.parse(localStorage.getItem('lastUsedConfig') || '{}');
                if (config.url) document.getElementById('url').value = config.url;
                if (config.key) document.getElementById('key').value = config.key;
                if (config.model) document.getElementById('model').value = config.model;
                if (config.endpoint) document.getElementById('endpoint').value = config.endpoint;
            }

            setupInputHandlers() {
                ['url', 'key', 'model', 'endpoint'].forEach(type => {
                    const input = document.getElementById(type);
                    const dropdown = document.getElementById(`${type}History`);

                    input.addEventListener('focus', () => {
                        if (type === 'endpoint') {
                            this.showEndpointDropdown();
                        } else {
                            this.showDropdown(type);
                        }
                    });

                    input.addEventListener('blur', () => {
                        setTimeout(() => this.hideDropdown(type), 200);
                    });

                    input.addEventListener('input', () => {
                        if (type === 'endpoint') {
                            this.filterEndpointHistory(input.value);
                        } else {
                            this.filterHistory(type, input.value);
                        }
                    });
                });

                // 清除配置按钮
                document.getElementById('clearConfig').addEventListener('click', () => {
                    this.clearAllHistory();
                });
            }

            showDropdown(type) {
                const dropdown = document.getElementById(`${type}History`);
                const history = this[`${type}History`];
                
                dropdown.innerHTML = '';
                history.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'history-item';
                    
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'content';
                    
                    if (type === 'key') {
                        const keySpan = document.createElement('span');
                        keySpan.className = 'key';
                        keySpan.textContent = item;
                        
                        const urlSpan = document.createElement('span');
                        urlSpan.className = 'url';
                        const mappedUrl = this.keyUrlMap[item];
                        urlSpan.textContent = mappedUrl || '(无URL记录)';
                        
                        contentDiv.appendChild(keySpan);
                        contentDiv.appendChild(urlSpan);
                    } else {
                        contentDiv.textContent = item;
                    }
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-btn';
                    deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
                    deleteBtn.setAttribute('title', '删除'); // 添加提示文本
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        this.deleteHistoryItem(type, item);
                    };
                    
                    div.appendChild(contentDiv);
                    div.appendChild(deleteBtn);
                    
                    div.addEventListener('click', (e) => {
                        if (!e.target.closest('.delete-btn')) {
                            document.getElementById(type).value = item;
                            if (type === 'key' && this.keyUrlMap[item]) {
                                document.getElementById('url').value = this.keyUrlMap[item];
                            }
                            this.hideDropdown(type);
                        }
                    });
                    
                    dropdown.appendChild(div);
                });
                
                dropdown.style.display = 'block';
            }

            filterEndpointHistory(value) {
                const dropdown = document.getElementById('endpointHistory');
                dropdown.innerHTML = '';

                const filteredHistory = this.endpointHistory.filter(endpoint =>
                    endpoint.toLowerCase().includes(value.toLowerCase())
                );

                const filteredCommon = this.commonEndpoints.filter(e => 
                    e.label.toLowerCase().includes(value.toLowerCase()) || 
                    e.value.toLowerCase().includes(value.toLowerCase())
                );


                // 总是先添加常用选项
                filteredCommon.forEach(endpoint => {
                    const div = document.createElement('div');
                    div.className = 'history-item';
                    div.textContent = endpoint.label;

                    div.addEventListener('click', () => {
                        document.getElementById('endpoint').value = endpoint.value;
                        this.hideDropdown('endpoint');
                    });

                    dropdown.appendChild(div);
                });


                // 然后添加过滤后的历史记录 (排除已存在的常用选项)
                filteredHistory.filter(item => !filteredCommon.map(e=>e.value).includes(item)).forEach(endpoint => {
                    const div = document.createElement('div');
                    div.className = 'history-item';
                    div.textContent = endpoint;

                    div.addEventListener('click', () => {
                        document.getElementById('endpoint').value = endpoint;
                        this.hideDropdown('endpoint');
                    });

                    dropdown.appendChild(div);
                });

                dropdown.style.display = (filteredCommon.length > 0 || filteredHistory.length > 0) ? 'block' : 'none';
            }


            showEndpointDropdown() {
                const dropdown = document.getElementById('endpointHistory');
                dropdown.innerHTML = '';

                // 先添加系统默认选项（不可删除）
                this.commonEndpoints.forEach(endpoint => {
                    const div = document.createElement('div');
                    div.className = 'history-item';
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'content';
                    contentDiv.textContent = endpoint.label;
                    div.appendChild(contentDiv);
                    
                    // 系统默认选项不显示删除按钮
                    div.addEventListener('click', () => {
                        document.getElementById('endpoint').value = endpoint.value;
                        this.hideDropdown('endpoint');
                    });

                    dropdown.appendChild(div);
                });

                // 添加用户自定义选项（可删除）
                this.endpointHistory
                    .filter(item => !this.commonEndpoints.map(e => e.value).includes(item))
                    .forEach(endpoint => {
                        const div = document.createElement('div');
                        div.className = 'history-item';
                        
                        const contentDiv = document.createElement('div');
                        contentDiv.className = 'content';
                        contentDiv.textContent = endpoint;
                        
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'delete-btn';
                        deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
                        deleteBtn.setAttribute('title', '删除');
                        deleteBtn.onclick = (e) => {
                            e.stopPropagation();
                            this.deleteHistoryItem('endpoint', endpoint);
                        };

                        div.appendChild(contentDiv);
                        div.appendChild(deleteBtn);
                        
                        div.addEventListener('click', () => {
                            document.getElementById('endpoint').value = endpoint;
                            this.hideDropdown('endpoint');
                        });

                        dropdown.appendChild(div);
                    });

                dropdown.style.display = 'block';
            }

            filterHistory(type, value) {
                const dropdown = document.getElementById(`${type}History`);
                const history = this[`${type}History`];
                
                dropdown.innerHTML = '';
                const filtered = history.filter(item => 
                    item.toLowerCase().includes(value.toLowerCase())
                );
                
                filtered.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'history-item';
                    
                    if (type === 'key') {
                        // 为过滤后的key添加对应的URL信息
                        const keySpan = document.createElement('span');
                        keySpan.className = 'key';
                        keySpan.textContent = item;
                        
                        const urlSpan = document.createElement('span');
                        urlSpan.className = 'url';
                        const mappedUrl = this.keyUrlMap[item];
                        urlSpan.textContent = mappedUrl || '(无URL记录)';
                        
                        div.appendChild(keySpan);
                        div.appendChild(urlSpan);
                    } else {
                        div.textContent = item;
                    }
                    
                    div.addEventListener('click', () => {
                        document.getElementById(type).value = item;
                        // 如果选择了key，自动填充对应的URL
                        if (type === 'key' && this.keyUrlMap[item]) {
                            document.getElementById('url').value = this.keyUrlMap[item];
                        }
                        this.hideDropdown(type);
                    });
                    
                    dropdown.appendChild(div);
                });
                
                dropdown.style.display = filtered.length ? 'block' : 'none';
            }

            hideDropdown(type) {
                document.getElementById(`${type}History`).style.display = 'none';
            }

            clearAllHistory() {
                this.urlHistory = [];
                this.keyHistory = [];
                this.modelHistory = [];
                this.keyUrlMap = {};
                this.saveHistory();
                localStorage.removeItem('lastUsedConfig');
                localStorage.removeItem('chatHistory'); // 清空聊天历史
                messages = [];
                document.getElementById('chatHistory').innerHTML = '';
                
                // 清空输入框
                document.getElementById('url').value = '';
                document.getElementById('key').value = '';
                document.getElementById('model').value = '';
            }
        }

        // 初始化配置历史记录管理
        const configHistory = new ConfigHistory();

        function getApiUrl(baseUrl, endpoint, model) {
            let cleanUrl = baseUrl.trim().replace(/\/+$/, '');
            
            if (endpoint === 'auto') {
                // 保持原有的自动判断逻辑
                const isClaudeModel = model.toLowerCase().includes('claude');
                return `${cleanUrl}/${isClaudeModel ? 'v1/messages' : 'v1/chat/completions'}`;
            } else {
                // 使用输入的路径
                return `${cleanUrl}${endpoint.startsWith('/') ? '' : '/'}${endpoint}`;
            }
        }

        // Function to send message
        async function sendMessage() {
            const originalUrl = document.getElementById('url').value.trim();
            const key = document.getElementById('key').value;
            const model = document.getElementById('model').value;
            const inputText = document.getElementById('input').value;
            const endpoint = document.getElementById('endpoint').value;
            
            if (!inputText.trim()) return;
            
            const chatHistory = document.getElementById('chatHistory');
            const spinner = document.querySelector('.spinner');
            spinner.style.display = 'block';

            try {
                const apiUrl = getApiUrl(originalUrl, endpoint, model);
                
                // 保存配置
                configHistory.addToHistory('url', originalUrl);
                configHistory.addToHistory('key', key);
                configHistory.addToHistory('model', model);
                configHistory.addToHistory('endpoint', endpoint);
                configHistory.updateKeyUrlMap(key, originalUrl);
                configHistory.saveLastUsedConfig();

                // 添加用户消息到历史记录
                messages.push({ role: "user", content: inputText, isError: false });
                chatHistory.innerHTML += `<div class="message user">${converter.makeHtml(inputText)}</div>`;

                const headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${key}`
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(createRequestBody(model, messages))
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => { return {error:{message:response.statusText}}}); // 尝试解析错误信息，如果解析失败则返回默认错误信息
                    throw new Error(`API 错误 (${response.status}): ${errorData?.error?.message || response.statusText}`); // 显示更具体的错误信息
                }

                const data = await response.json();
                let content;

                if (endpoint === '/v1/messages' || (endpoint === 'auto' && model.toLowerCase().includes('claude'))) {
                    if (data.content && data.content.length > 0) { // 检查 content 是否存在和长度
                        content = data.content[0].text;
                    } else {
                        throw new Error("API 返回了无效的响应数据（缺少 content 字段）");
                    }
                } else {
                    if (data.choices && data.choices.length > 0) {
                        content = data.choices[0].message?.content || "没有返回内容";
                    } else {
                        throw new Error("API 返回了无效的响应数据（缺少 choices 字段）"); //  更明确的错误信息
                    }
                }

                messages.push({ role: "assistant", content: content, isError: false });
                chatHistory.innerHTML += `<div class="message assistant">${converter.makeHtml(content)}</div>`;
                chatHistory.scrollTop = chatHistory.scrollHeight;

                // 保存聊天历史
                configHistory.saveChatHistory();
                
                // 只在成功发送后清空输入框
                document.getElementById('input').value = '';
            } catch (error) {
                const errorMsg = {
                    role: "assistant",
                    content: `请求失败: ${error.message}`,
                    isError: true
                };
                messages.push(errorMsg);
                displayMessage(errorMsg, "assistant", true);
                
                // 保存包含错误信息的聊天历史
                configHistory.saveChatHistory();
            } finally {
                spinner.style.display = 'none';
            }
        }

        // 获取指定时区的当前时间
        function getCurrentTime(timezone = 'Asia/Shanghai') {
            try {
                const options = {
                    timeZone: timezone,
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                };
                return new Date().toLocaleTimeString('zh-CN', options);
            } catch (error) {
                // 如果时区无效,返回本地时间
                return new Date().toLocaleTimeString('zh-CN', { hour12: false });
            }
        }

        // 创建请求体函数
        function createRequestBody(model, messages) {
            const isClaudeModel = model.toLowerCase().includes('claude');
            
            if (isClaudeModel) {
                // Claude模型的请求体
                return {
                    model: model,
                    max_tokens: parseInt(document.getElementById('max_tokens').value),
                    messages: messages.map(msg => ({
                        role: msg.role,
                        content: msg.content
                    }))
                };
            } else {
                // OpenAI模型的请求体
                return {
                    model: model,
                    messages: messages,
                    temperature: parseFloat(document.getElementById('temperature').value),
                    max_tokens: parseInt(document.getElementById('max_tokens').value),
                    top_p: parseFloat(document.getElementById('top_p').value),
                    frequency_penalty: parseFloat(document.getElementById('frequency_penalty').value),
                    presence_penalty: parseFloat(document.getElementById('presence_penalty').value)
                };
            }
        }

        // 测试函数调用能力
        async function testFunctionCallCapability() {
            // 在测试前保存配置
            const originalUrl = document.getElementById('url').value.trim();
            const key = document.getElementById('key').value;
            const model = document.getElementById('model').value;
            const isClaudeModel = model.toLowerCase().includes('claude');
            const endpoint = document.getElementById('endpoint').value;

            const apiUrl = getApiUrl(originalUrl, endpoint, model);

            configHistory.addToHistory('url', originalUrl);
            configHistory.addToHistory('key', key);
            configHistory.addToHistory('model', model);
            configHistory.updateKeyUrlMap(key, originalUrl);
            configHistory.saveLastUsedConfig({ url: originalUrl, key, model });

            const chatHistory = document.getElementById('chatHistory');
            const spinner = document.querySelector('.spinner');
            spinner.style.display = 'block';

            try {
                const headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${key}`
                };

                if (isClaudeModel) {
                    headers['anthropic-version'] = '2023-06-01';
                }

                const requestBody = isClaudeModel ? {
                    // Claude的工具调用请求体
                    model: model,
                    max_tokens: 1024,
                    tools: [{
                        name: "get_current_time",
                        description: "返回指定时区的当前系统时间，格式为HH:MM:SS。这个函数应该在用户询问当前时间或需要了解特定时区时间时使用。",
                        input_schema: {
                            type: "object",
                            properties: {
                                timezone: {
                                    type: "string",
                                    description: "时区名称，例如 'UTC', 'Asia/Shanghai'"
                                }
                            },
                            required: ["timezone"]
                        }
                    }],
                    messages: [{
                        role: "user",
                        content: "What is the current time in Shanghai?"
                    }],
                    tool_choice: { type: "tool", name: "get_current_time" }
                } : {
                    // OpenAI的函数调用请求体
                    model: model,
                    messages: [{
                        role: "user",
                        content: "What time is it in Shanghai?"
                    }],
                    functions: [{
                        name: "get_current_time",
                        description: "Returns the current system time in HH:MM:SS format",
                        parameters: {
                            type: "object",
                            properties: {
                                timezone: {
                                    type: "string",
                                    description: "Timezone for the time"
                                }
                            },
                            required: ["timezone"]
                        }
                    }],
                    function_call: { name: "get_current_time" }
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => { return {error:{message:response.statusText}}}); 
                    // 直接使用 errorData.error.message 作为错误信息显示
                    chatHistory.innerHTML += `<div class="message assistant error">请求失败: ${errorData.error.message}</div>`;
                    chatHistory.scrollTop = chatHistory.scrollHeight;
                    spinner.style.display = 'none';
                    return; // 提前返回，避免继续执行
                }

                const data = await response.json();
                
                // 解析响应
                if (isClaudeModel) {
                // 检查Claude的工具调用响应
                const toolCall = data.content?.find(content => 
                    content.type === "tool_calls" || 
                    content.type === "tool_use"
                );
                
                if (toolCall) {
                    const requestedTimezone = toolCall.input?.timezone || 'Asia/Shanghai';
                    const currentTime = getCurrentTime(requestedTimezone);
                    chatHistory.innerHTML += `
                        <div class="message assistant">
                            工具调用成功！<br>
                            请求获取时区: ${requestedTimezone}<br>
                            当前时间为: ${currentTime}
                        </div>`;
                    } else {
                        //  Claude 没有调用工具
                        let message = "Claude 没有调用工具";

                        if (data.choices && data.choices.length > 0 && data.choices[0].message && data.choices[0].message.content) {
                            message += "，并返回了以下信息：<br>" + converter.makeHtml(data.choices[0].message.content);
                        } else if (data.error && data.error.message) {
                            message += `: ${data.error.message}`;
                        } else {
                            message += "，且未返回其他信息。";
                        }

                        chatHistory.innerHTML += `<div class="message assistant error">${message}</div>`;
                    }

                chatHistory.scrollTop = chatHistory.scrollHeight;
            } else {
                // 检查OpenAI的函数调用响应
                const functionCall = data.choices[0]?.message?.function_call;
                if (functionCall) {
                    try {
                        const args = JSON.parse(functionCall.arguments);
                        const requestedTimezone = args.timezone || 'Asia/Shanghai';
                        const currentTime = getCurrentTime(requestedTimezone);
                        chatHistory.innerHTML += `
                            <div class="message assistant">
                                函数调用成功！<br>
                                请求获取时区: ${requestedTimezone}<br>
                                当前时间为: ${currentTime}
                            </div>`;
                    } catch (error) {
                        chatHistory.innerHTML += `
                            <div class="message assistant error">
                                函数调用成功,但参数解析失败: ${functionCall.arguments}
                            </div>`;
                    }
                } else {
                // 优先显示 choices 中的内容，即使没有调用函数
                const modelReply = data.choices[0]?.message?.content;
                if (modelReply) {
                    chatHistory.innerHTML += `<div class="message assistant error">模型没有调用工具，并返回了以下信息：<br>${converter.makeHtml(modelReply)}</div>`;
                } else if (data.error && data.error.message) {
                    chatHistory.innerHTML += `<div class="message assistant error">函数调用失败：${data.error.message}</div>`;
                } else {
                    chatHistory.innerHTML += `<div class="message assistant error">函数调用失败：未知错误</div>`;
                }
            }
            }
            } catch (error) {
                const errorData = await response.json().catch(() => { return {error:{message:response.statusText}}}); 
                chatHistory.innerHTML += `<div class="message assistant error">请求失败: ${errorData}</div>`;
            } finally {
                chatHistory.scrollTop = chatHistory.scrollHeight;
                spinner.style.display = 'none';
            }
        }

        // 清空历史
        function clearHistory() {
            if (confirm('确定要清空所有历史记录吗？这将包括聊天记录和配置历史。')) {
                configHistory.clearAllHistory();
            }
        }

        // 事件监听器
        document.getElementById('submit').onclick = sendMessage;
        document.getElementById('functionTest').onclick = testFunctionCallCapability;
        document.getElementById('clearHistory').onclick = function() {
            if (confirm('确定要清空聊天历史记录吗？')) {
                // 只清空聊天历史，保留配置历史
                localStorage.removeItem('chatHistory');
                messages = [];
                document.getElementById('chatHistory').innerHTML = '';
            }
        };
        document.addEventListener('DOMContentLoaded', function() {
            const endpointSelect = document.getElementById('endpoint');
            const customEndpoint = document.getElementById('customEndpoint');

            endpointSelect.addEventListener('change', function() {
                if (this.value === 'custom') {
                    customEndpoint.style.display = 'block';
                } else {
                    customEndpoint.style.display = 'none';
                }
            });
        });

        // 支持Enter发送
        document.getElementById('input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // 添加打开 NextChat 的处理函数
        document.getElementById('openNextChat').onclick = function() {
            const settings = {
                key: document.getElementById('key').value,
                url: document.getElementById('url').value.trim()
            };

            // 构建 NextChat URL
            const baseUrl = 'https://app.nextchat.dev/#/';
            const fullUrl = `${baseUrl}?settings=${JSON.stringify(settings)}`;

            // 设置iframe的src并显示模态框
            document.getElementById('nextChatFrame').src = fullUrl;
            document.getElementById('nextChatModal').style.display = 'block';
        };

        // 添加关闭模态框的函数
        function closeNextChat() {
            document.getElementById('nextChatModal').style.display = 'none';
            document.getElementById('nextChatFrame').src = ''; // 清空iframe源以停止加载
        }

        // 点击模态框背景时关闭
        document.getElementById('nextChatModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeNextChat();
            }
        });
    </script>
</body>
</html>
